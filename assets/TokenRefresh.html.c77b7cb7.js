import{_ as n,o as s,c as a,e as t}from"./app.a35418cc.js";const p={},e=t(`<h1 id="token-\u65E0\u611F\u5237\u65B0" tabindex="-1"><a class="header-anchor" href="#token-\u65E0\u611F\u5237\u65B0" aria-hidden="true">#</a> Token \u65E0\u611F\u5237\u65B0</h1><h2 id="_1-\u4F7F\u7528\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#_1-\u4F7F\u7528\u573A\u666F" aria-hidden="true">#</a> 1. \u4F7F\u7528\u573A\u666F</h2><p>\u7528\u6237\u6B63\u5728\u586B\u5199\u4E00\u4E2A\u5185\u5BB9\u5F88\u591A\u7684\u8868\u5355\uFF0C\u8D39\u65F6\u8D39\u529B\u7684\u586B\u5199\u5B8C\u6210\u540E\u70B9\u51FB\u63D0\u4EA4\uFF0C\u6B64\u65F6\u521A\u597D <code>token</code> \u8FC7\u671F\uFF0C\u5982\u679C\u76F4\u63A5\u8DF3\u8F6C\u5230\u767B\u5F55\u9875\uFF0C\u90A3\u5C31\u4F1A\u4E22\u5931\u7528\u6237\u586B\u5199\u7684\u5185\u5BB9\uFF0C\u4F53\u9A8C\u975E\u5E38\u4E0D\u597D\u3002</p><p>\u6240\u4EE5\u8981\u5B9E\u73B0\u7528\u6237\u5728\u64CD\u4F5C\u8FC7\u7A0B\u4E2D\uFF0C\u65E0\u611F\u5237\u65B0\u8FC7\u671F <code>token</code>\uFF0C\u7EE7\u7EED\u6267\u884C\u7528\u6237\u7684\u8BF7\u6C42\uFF0C\u786E\u4FDD\u4E0D\u4F1A\u56E0 <code>token</code> \u8FC7\u671F\u8DF3\u8F6C\u767B\u5F55\u9875\u800C\u9020\u6210\u6570\u636E\u4E22\u5931\u3002</p><br><h2 id="_2-\u5B9E\u73B0\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#_2-\u5B9E\u73B0\u601D\u8DEF" aria-hidden="true">#</a> 2. \u5B9E\u73B0\u601D\u8DEF</h2><blockquote><p>\u501F\u52A9 axios \u7684\u8BF7\u6C42\u62E6\u622A\u5668\u548C\u54CD\u5E94\u62E6\u622A\u5668\u8FDB\u884C\u5B9E\u73B0\u3002</p></blockquote><p>\u8BF7\u6C42\u62E6\u622A\u5668\u4E2D\uFF1A</p><ol><li><p>\u8BBE\u7F6E\u4E00\u4E2A\u6D3B\u8DC3\u65F6\u957F\uFF0C<code>token</code> \u8FC7\u671F\u540E\uFF0C\u5982\u679C\u5728\u8FD9\u4E2A\u6D3B\u8DC3\u65F6\u957F\u5185\u8FD8\u6709\u8BF7\u6C42\uFF0C\u5C31\u53BB\u5237\u65B0 <code>token</code>\uFF0C\u5982\u679C\u8D85\u8FC7\u8FD9\u4E2A\u65F6\u957F\u518D\u53BB\u8BF7\u6C42\uFF0C\u5219\u6267\u884C\u9000\u51FA\u767B\u5F55\u64CD\u4F5C\u3002</p></li><li><p>\u4E3A\u4E86\u9632\u6B62\u591A\u4E2A\u8BF7\u6C42\u540C\u65F6\u6267\u884C\u5237\u65B0 <code>token</code> \u64CD\u4F5C\uFF0C\u9700\u8981\u8BBE\u7F6E\u4E00\u4E2A\u6807\u8BC6\u6765\u5224\u65AD\u5F53\u524D\u662F\u5426\u6B63\u5728\u5237\u65B0 <code>token</code>\u3002</p></li><li><p>\u4E00\u4E2A\u9875\u9762\u4E00\u822C\u4F1A\u6709\u5F88\u591A\u8BF7\u6C42\uFF0C\u5F53\u5176\u4E2D\u67D0\u4E00\u4E2A\u8BF7\u6C42\u5F00\u59CB\u6267\u884C\u5237\u65B0 <code>token</code> \u64CD\u4F5C\u65F6\uFF0C\u5176\u4ED6\u8BF7\u6C42\u6682\u65F6\u6302\u8D77\uFF0C\u653E\u5230\u4E00\u4E2A\u7F13\u5B58\u961F\u5217\u4E2D\uFF0C\u7B49 <code>token</code> \u5237\u65B0\u5B8C\u6210\u540E\u518D\u4F9D\u6B21\u6267\u884C\u7F13\u5B58\u961F\u5217\u4E2D\u7684\u8BF7\u6C42\u3002</p></li></ol><br><p>\u54CD\u5E94\u62E6\u622A\u5668\u4E2D\uFF1A</p><p>\u5982\u679C\u63A5\u53E3\u8FD4\u56DE <code>401</code> \u6216 <code>403</code>\uFF0C\u5219\u6267\u884C\u9000\u51FA\u767B\u5F55\u64CD\u4F5C\u3002</p><br><h2 id="_3-\u5177\u4F53\u4EE3\u7801" tabindex="-1"><a class="header-anchor" href="#_3-\u5177\u4F53\u4EE3\u7801" aria-hidden="true">#</a> 3. \u5177\u4F53\u4EE3\u7801</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">&#39;axios&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> parseToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/utils/auth&#39;</span> <span class="token comment">// \u89E3\u6790 token \u7684\u65B9\u6CD5</span>

<span class="token comment">// \u8BF7\u6C42\u5934\u4E0D\u9700\u8981\u643A\u5E26 token \u7684\u8BF7\u6C42</span>
<span class="token keyword">const</span> uapi <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">60000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// \u8BF7\u6C42\u5934\u9700\u8981\u643A\u5E26 token \u7684\u8BF7\u6C42</span>
<span class="token keyword">const</span> api <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">60000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> isRefreshing <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// \u662F\u5426\u6B63\u5728\u5237\u65B0 token \u7684\u6807\u8BC6</span>
<span class="token keyword">let</span> cacheRequests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// \u7F13\u5B58\u8BF7\u6C42\u961F\u5217</span>

<span class="token comment">// \u8BF7\u6C42\u62E6\u622A\u5668</span>
api<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token parameter">config</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&#39;AccessToken&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> accessExp <span class="token operator">=</span> <span class="token function">parseToken</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&#39;AccessToken&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exp <span class="token comment">// AccessToken \u8FC7\u671F\u65F6\u95F4</span>
      <span class="token keyword">const</span> activePeriod <span class="token operator">=</span> <span class="token number">7200</span> <span class="token comment">// \u6D3B\u8DC3\u65F6\u957F\uFF1A2h</span>
      <span class="token keyword">const</span> currentTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// \u8F6C\u6362\u6210 unix \u65F6\u95F4\u6233</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">&gt;</span> accessExp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">-</span> accessExp <span class="token operator">&lt;</span> activePeriod<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// \u6D3B\u8DC3\u65F6\u957F\u5185\u5237\u65B0 token</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRefreshing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isRefreshing <span class="token operator">=</span> <span class="token boolean">true</span>
            uapi<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/refresh_token&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token comment">// \u6267\u884C\u5237\u65B0 token \u63A5\u53E3</span>
              <span class="token literal-property property">accessToken</span><span class="token operator">:</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&#39;AccessToken&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token literal-property property">refreshToken</span><span class="token operator">:</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&#39;RefreshToken&#39;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&#39;AccessToken&#39;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>accessToken<span class="token punctuation">)</span>
              localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">&#39;RefreshToken&#39;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>refreshToken<span class="token punctuation">)</span>
              config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authentication <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&#39;AccessToken&#39;</span><span class="token punctuation">)</span> <span class="token comment">// \u8BF7\u6C42\u5934\u4E2D\u66FF\u6362\u65B0\u7684 token</span>
              cacheRequests<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// \u4F9D\u6B21\u6267\u884C\u6302\u8D77\u7684\u8BF7\u6C42</span>
              cacheRequests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// \u8BF7\u6C42\u5B8C\u540E\u6E05\u7A7A\u7F13\u5B58\u8BF7\u6C42\u961F\u5217</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">// \u6267\u884C\u9000\u51FA\u767B\u5F55\u64CD\u4F5C</span>
              <span class="token comment">// ...</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              isRefreshing <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment">// \u6B64\u5904\u4E00\u5B9A\u8981\u5C06\u7B2C\u4E00\u4E2A\u8BF7\u6C42\u5237\u65B0 token \u7684\u63A5\u53E3\u653E\u5230\u7F13\u5B58\u961F\u5217\u4E2D\uFF0C\u4E0D\u7136\u6CA1\u6CD5\u7EE7\u7EED\u6B64\u8BF7\u6C42</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              cacheRequests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">token</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authentication <span class="token operator">=</span> token <span class="token comment">//  \u8BF7\u6C42\u5934\u4E2D\u66FF\u6362\u65B0\u7684 token</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5C06\u540C\u65F6\u8BF7\u6C42\u7684\u63A5\u53E3\u653E\u5165\u7F13\u5B58\u961F\u5217</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              cacheRequests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">token</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authentication <span class="token operator">=</span> token
                <span class="token comment">// \u5C06\u8BF7\u6C42\u6302\u8D77</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// \u6267\u884C\u9000\u51FA\u767B\u5F55\u64CD\u4F5C</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authentication <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">&#39;AccessToken&#39;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> config
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> config
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">// \u54CD\u5E94\u62E6\u622A\u5668</span>
api<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> response
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">401</span> <span class="token operator">||</span> error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">403</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// \u6267\u884C\u9000\u51FA\u767B\u5F55\u64CD\u4F5C</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,15),o=[e];function c(l,i){return s(),a("div",null,o)}const k=n(p,[["render",c],["__file","TokenRefresh.html.vue"]]);export{k as default};
